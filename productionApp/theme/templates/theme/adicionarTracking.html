{% extends 'theme/base.html' %}
{% block title %}{% if tracking %}Editar Tracking{% else %}Adicionar Tracking{% endif %}{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">
  {% if tracking %}Editar Tracking{% else %}Adicionar Tracking{% endif %}
</h1>

<form id="trackingForm" method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="space-y-4">
    <div class="bg-white shadow p-4 rounded grid grid-cols-1 md:grid-cols-4 gap-4">

      <div>
        <label class="block text-sm">Data</label>
        <input type="date" name="data" class="border p-2 w-full" required
               value="{% if tracking and tracking.data %}{{ tracking.data|date:'Y-m-d' }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Finalidade</label>
        <select name="finalidade" class="border p-2 w-full" required>
          <option value="">Selecione</option>
          {% for value, label in finalidades %}
            <option value="{{ value }}" {% if tracking and tracking.finalidade == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm">CRM</label>
        <input type="text" name="crm" class="border p-2 w-full" required
               value="{% if tracking %}{{ tracking.crm }}{% endif %}">
      </div>

      <!-- Remetente (só Importacao) -->
      <div id="remetenteField" style="display:none;">
        <label class="block text-sm">Remetente</label>
        <input type="text" name="remetente" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.remetente }}{% endif %}">
      </div>

      <!-- Destinatário (só Exportacao) -->
      <div id="destinatarioField" style="display:none;">
        <label class="block text-sm">Destinatário</label>
        <input type="text" name="destinatario" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.destinatario }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Transportadora</label>
        <select name="transportadora" class="border p-2 w-full" required>
          <option value="">Selecione</option>
          {% for courier in transportadoras %}
            <option value="{{ courier }}" {% if tracking and tracking.transportadora == courier %}selected{% endif %}>{{ courier }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm">Carta de Porte</label>
        <input type="text" name="carta_de_porte" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.carta_de_porte }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Número de Recolha</label>
        <input type="text" name="numero_recolha" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.numero_recolha }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Recebido por</label>
        <input type="text" name="recebido_por" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.recebido_por }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Data de Entrega</label>
        <input type="date" name="data_entrega" class="border p-2 w-full"
               value="{% if tracking and tracking.data_entrega %}{{ tracking.data_entrega|date:'Y-m-d' }}{% endif %}">
      </div>

      <div>
        <label class="block text-sm">Email</label>
        <input type="text" name="email" class="border p-2 w-full"
               value="{% if tracking %}{{ tracking.email }}{% endif %}">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm">Observações</label>
        <textarea name="observacoes" class="border p-2 w-full" rows="3">{% if tracking %}{{ tracking.observacoes }}{% endif %}</textarea>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm mb-1">Ficheiros (arraste/solte ou clique)</label>
        <div id="dropzone"
             class="relative border-dashed border-2 border-gray-300 p-4 text-center cursor-pointer rounded">
          Arraste e solte aqui ou clique para selecionar.
          <input id="fileInput" name="files" type="file" multiple
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                 aria-label="Selecionar ficheiros">
        </div>
        <div class="flex items-center justify-between mt-2">
          <ul id="filesPreview" class="text-sm text-gray-700 space-y-1 flex-1"></ul>
          <button id="clearAll" type="button" class="ml-4 text-xs px-2 py-1 border rounded hover:bg-gray-50">Limpar todos</button>
        </div>
      </div>

      {% if tracking %}
      <div class="md:col-span-4 mt-3 text-sm">
        <div class="text-gray-500 mb-1">Anexos atuais:</div>
        <ul class="space-y-1">
          {% for file in tracking.files.all %}
            <li class="flex items-center gap-3">
              <a href="{{ file.file.url }}" class="text-blue-600 underline" target="_blank" rel="noreferrer" download
                 title="{{ file.file.name }}">
                {{ file.file.name|cut:"tracking_files/" }}
              </a>
              <span class="text-gray-400">· {{ file.uploaded_at|date:"Y-m-d H:i" }}</span>
              <label class="ml-auto inline-flex items-center gap-2">
                <input type="checkbox" name="delete_files" value="{{ file.id }}" class="h-4 w-4">
                <span class="text-red-600">Remover</span>
              </label>
            </li>
          {% empty %}
            <li class="text-gray-500">Sem ficheiros</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </div>
  </div>

  <div class="mt-6 flex items-center gap-2">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
      {% if tracking %}Guardar alterações{% else %}Salvar{% endif %}
    </button>
    <a href="{% url 'listarTracking' %}" class="px-4 py-2 border rounded">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>

  document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('fileInput');
    const filesPreview = document.getElementById('filesPreview');
    const clearAllButton = document.getElementById('clearAll');

    fileInput.addEventListener('change', () => {
      filesPreview.innerHTML = '';
      Array.from(fileInput.files).forEach(file => {
        const li = document.createElement('li');
        li.textContent = file.name;
        filesPreview.appendChild(li);
      });
    });

    clearAllButton.addEventListener('click', () => {
      fileInput.value = '';
      filesPreview.innerHTML = '';
    });
  });
  document.addEventListener('DOMContentLoaded', () => {
    const finalidadeField   = document.querySelector('select[name="finalidade"]');
    const remetenteWrap     = document.getElementById('remetenteField');
    const destinatarioWrap  = document.getElementById('destinatarioField');
    const remetenteInput    = document.querySelector('input[name="remetente"]');
    const destinatarioInput = document.querySelector('input[name="destinatario"]');

    function toggleFields() {
      const val = finalidadeField ? finalidadeField.value : '';
      if (val === 'Importacao') {
        // Importação: mostrar Remetente
        remetenteWrap.style.display = 'block';
        destinatarioWrap.style.display = 'none';
        // required
        remetenteInput && remetenteInput.setAttribute('required','required');
        destinatarioInput && destinatarioInput.removeAttribute('required');
        // limpar o oculto
        if (destinatarioInput) destinatarioInput.value = '';
      } else if (val === 'Exportacao') {
        // Exportação: mostrar Destinatário
        remetenteWrap.style.display = 'none';
        destinatarioWrap.style.display = 'block';
        destinatarioInput && destinatarioInput.setAttribute('required','required');
        remetenteInput && remetenteInput.removeAttribute('required');
        if (remetenteInput) remetenteInput.value = '';
      } else {
        // Nenhuma selecionada
        remetenteWrap.style.display = 'none';
        destinatarioWrap.style.display = 'none';
        remetenteInput && remetenteInput.removeAttribute('required');
        destinatarioInput && destinatarioInput.removeAttribute('required');
      }
    }

    if (finalidadeField) {
      finalidadeField.addEventListener('change', toggleFields);
      toggleFields(); // estado inicial (útil ao editar)
    }

    // --- opcional: impedir submit sem o condicional correto (extra robustez) ---
    const form = document.getElementById('trackingForm');
    form && form.addEventListener('submit', (e) => {
      const val = finalidadeField ? finalidadeField.value : '';
      if (val === 'Importacao' && remetenteInput && !remetenteInput.value.trim()) {
        e.preventDefault();
        remetenteInput.focus();
        alert('Preencha o Remetente (Finalidade: Importação).');
      }
      if (val === 'Exportacao' && destinatarioInput && !destinatarioInput.value.trim()) {
        e.preventDefault();
        destinatarioInput.focus();
        alert('Preencha o Destinatário (Finalidade: Exportação).');
      }
    });
  });
</script>
{% endblock %}
