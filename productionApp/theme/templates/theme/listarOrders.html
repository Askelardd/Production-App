{% extends 'theme/base.html' %}
{% block title %}Orders{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-white mb-8">Orders</h1>

<!-- Barra de Pesquisa -->
<div class="mb-4">
    <input type="text" id="searchInput" placeholder="Pesquisar em todos os campos..."
           class="w-full md:w-1/2 px-4 py-2 border rounded shadow focus:outline-none focus:ring focus:ring-blue-300" />
</div>
<div class="overflow-x-auto w-full max-w-7xl bg-white rounded-lg shadow-lg p-6">
    <table id="deliveryTable" class="min-w-full table-auto text-xs md:text-sm text-left">
        <thead class="bg-custom-blue text-white">
            <tr>
                <th class="px-4 py-3">Tracking Number</th>
                <th class="px-4 py-3">Orders Coming</th>
                <th class="px-4 py-3">Courier</th>
                <th class="px-4 py-3">Shipping Date</th>
                <th class="px-4 py-3">Comment</th>
                <th class="px-4 py-3">Files</th>
                <th class="px-4 py-3 text-center">Actions</th>
            </tr>
        </thead>
        <tbody id="deliveryTableBody">
            {% for o in orders %}
            <tr class="border-b hover:bg-gray-100 transition-colors">
                <td class="px-4 py-2">{{ o.tracking_number }}</td>
                <td class="px-4 py-2 whitespace-pre-line">
                {{ o.orders_coming|linebreaksbr }}
                </td>
                <td class="px-4 py-2">{{ o.courier }}</td>
                <td class="px-4 py-2">{{ o.shipping_date }}</td>
                <td class="px-4 py-2 whitespace-pre-line">
                    {{ o.comment|linebreaksbr }}
                </td>
                <td class="px-4 py-2">
                    {% if o.files.all %}
                        <ul class="space-y-1">
                        {% for f in o.files.all %}
                        {% if not f.restricted or is_admin %}
                            <li class="flex items-center gap-2">
                            <a href="{{ f.file.url }}" target="_blank" class="text-blue-600 hover:underline">
                                {{ f.file.name|cut:"order_files/" }}
                            </a>
                            {% if f.restricted %}
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">Restrito</span>
                            {% endif %}
                            </li>
                        {% else %}
                            <li class="text-gray-400 italic">[Ficheiro restrito]</li>
                        {% endif %}
                        {% endfor %}
                        </ul>
                    {% else %}
                        <span class="text-gray-500">â€”</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2 space-y-1 md:space-y-0 md:flex md:gap-2 justify-center">
                    <a href="{% url 'editOrder' o.id %}" class="inline-block px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs md:text-sm transition">Edit</a>
                    <form action="{% url 'deleteOrder' o.id %}" method="post" class="inline"
                                onsubmit="return confirm('Apagar esta order e todos os ficheiros?');">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-xs md:text-sm transition">Delete</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-gray-500 py-4">Nenhuma order registrada.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('deliveryTableBody');

    if (!searchInput || !tableBody) return;

    searchInput.addEventListener('keyup', function () {
        const filter = searchInput.value.toLowerCase();
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach(function(row) {
            const cells = row.getElementsByTagName('td');
            let found = false;

            // Verifica todas as colunas
            for (let j = 0; j < cells.length; j++) {
                const text = (cells[j].textContent || '').toLowerCase();
                if (text.includes(filter)) {
                    found = true;
                    break;
                }
            }

            row.style.display = found ? '' : 'none';
        });
    });
});
</script>
{% endblock %}

