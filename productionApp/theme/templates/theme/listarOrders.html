{% extends 'theme/base.html' %}

{% block title %}Orders criadas{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-white mb-8">Orders criadas</h1>

<!-- Barra de Pesquisa -->
<div class="mb-4">
  <input type="text" id="searchInput" placeholder="Pesquisar em todos os campos..."
    class="w-full md:w-1/2 px-4 py-2 border rounded shadow focus:outline-none focus:ring focus:ring-blue-300" />
  {% if is_admin %}
    <a href="{% url 'orders' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
      Nova Order
    </a>
  {% endif %}
</div>

<div class="relative">
  <!-- Scrollbar superior -->
  <div id="topScroller" class="overflow-x-auto h-4 mb-2">
    <div id="topScrollerInner" class="h-1"></div>
  </div>

  <!-- Tabela scrollável -->
  <div id="tableScroller" class="overflow-x-auto w-full max-w-7xl bg-white rounded-lg shadow-lg p-6">
    <table id="ordersTable" class="min-w-full table-auto text-xs md:text-sm text-left">
      <thead class="bg-blue-600 text-white uppercase font-semibold text-sm">
        <tr>
          <th class="px-4 py-3">Plant</th>
          <th class="px-4 py-3">Tracking</th>
          <th class="px-4 py-3">Courier</th>
          <th class="px-4 py-3">Shipping Date</th>
          <th class="px-4 py-3">Arriving Date</th>
          <th class="px-4 py-3 min-w-[260px]">Orders Coming</th>
          <th class="px-4 py-3">Tasks</th>
          <th class="px-4 py-3">Status</th>
          <th class="px-4 py-3">Comments</th>
          <th class="px-4 py-3">Ficheiros</th>
          {% if is_qOffice %}
          <th class="px-4 py-3">Exportado</th> 
          {% endif %}
          <th class="px-4 py-3 text-right">Ações</th>
        </tr>
      </thead>
      <tbody class="text-gray-800">
        {% for o in orders %}
          <tr class="border-b hover:bg-gray-100 transition-colors">
            <td class="px-4 py-2">{{ o.plant }}</td>
            <td class="px-4 py-2">{{ o.tracking_number }}</td>
            <td class="px-4 py-2">{{ o.courier }}</td>
            <td class="px-4 py-2">{{ o.shipping_date|default:"—" }}</td>
            <td class="px-4 py-2">{{ o.arriving_date|default:"—" }}</td>
            <td class="px-4 py-2">
              {% if o.orders_coming.all %}
                <ul class="list-disc list-inside space-y-1">
                  {% for oc in o.orders_coming.all %}
                    <li>
                      <a href="{% url 'editOrdersComing' oc.id %}" class="text-blue-600 hover:underline">
                        {{ oc.order|linebreaksbr|safe|cut:"<br />"|truncatechars:40 }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if o.orders_coming.all %}
                <ul class="space-y-1">
                  {% for oc in o.orders_coming.all %}
                    <li>
                      {% if oc.inspectionMetrology or oc.preshipment or oc.mark or oc.urgent %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800 whitespace-nowrap">
                        Have Tasks
                      </span>
                      {% else %}
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700 whitespace-nowrap">
                        No Tasks
                      </span>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% for oc in o.orders_coming.all %}
                {% if oc in ordersComing %}
                  <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    {% if oc.done == True %}Done{% else %}Pending{% endif %}
                  </span>
                {% endif %}
              {% empty %}
                <span class="text-gray-400">—</span>
              {% endfor %}
            </td>
            <td class="px-4 py-2">{{ o.comment|linebreaksbr|default:"—" }}</td>
            <td class="px-4 py-2">
              {% for f in o.files.all %}
                <div>
                  {% if f.restricted and not is_admin %}
                    <span class="text-gray-500 italic">Ficheiro restrito</span>
                  {% else %}
                    <a href="{{ f.file.url }}" class="text-blue-600 underline" target="_blank">
                      {{ f.file.name|cut:"order_files/"|cut:".pdf"|cut:".docx"|cut:".txt"|cut:".xlsx"|cut:".jpg"|cut:".png" }}
                    </a>
                    {% if f.restricted %}
                      <span class="text-xs text-red-600 ml-1">(restrito)</span>
                    {% endif %}
                  {% endif %}
                </div>
              {% empty %}
                <span class="text-gray-500">—</span>
              {% endfor %}
            </td>
            {% if is_qOffice %}
            <td class="px-4 py-2">
              {% if o.exportado %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800">
                  Exportado
                </span>
              {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700">
                  Nunca
                </span>
              {% endif %}
            </td>
            {% endif %}
            <td class="px-4 py-2 text-right">
              <div class="flex flex-col gap-2 items-end">
                <a href="{% url 'editOrder' o.id %}"
                  class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition w-full text-center">
                  Editar
                </a>
                <form method="POST" action="{% url 'deleteOrder' o.id %}" class="w-full">
                  {% csrf_token %}
                  <button type="submit"
                          class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition w-full text-center"
                          onclick="return confirm('Deseja realmente eliminar esta order e os seus ficheiros?');">
                    Eliminar
                  </button>
                </form>
                <a href="{% url 'exportOrderExcel' o.id %}"
                  class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition w-full text-center export-btn">
                  {% if o.exportado %}Reexportar Excel{% else %}Exportar Excel{% endif %}
                </a>
              </div>
            </td>

          </tr>
        {% empty %}
          <tr>
            <td colspan="9" class="text-center text-gray-500 py-4">Sem orders ainda.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

  // Pesquisa já existente
  document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(query) ? '' : 'none';
    });
  });

  // Scroll superior sincronizado
  const tableScroller = document.getElementById('tableScroller');
  const topScroller = document.getElementById('topScroller');
  const topInner = document.getElementById('topScrollerInner');

  function syncWidths() {
    topInner.style.width = tableScroller.scrollWidth + 'px';
  }

  tableScroller.addEventListener('scroll', () => {
    topScroller.scrollLeft = tableScroller.scrollLeft;
  });

  topScroller.addEventListener('scroll', () => {
    tableScroller.scrollLeft = topScroller.scrollLeft;
  });

  window.addEventListener('load', syncWidths);
  
  // Pesquisa existente (mantém)
  document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(query) ? '' : 'none';
    });
  });

  // Refresh suave após exportar
  document.querySelectorAll('.export-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const original = btn.textContent;
      btn.textContent = 'A gerar…';
      btn.classList.add('opacity-70','pointer-events-none');

      // refresca a página passados 2.5s para mostrar o estado atualizado
      setTimeout(() => { window.location.reload(); }, 2500);

      // fallback: se algo correr mal, restaura após 8s
      setTimeout(() => {
        btn.textContent = original;
        btn.classList.remove('opacity-70','pointer-events-none');
      }, 8000);
    });
  });
</script>
{% endblock %}