{% extends 'theme/base.html' %}

{% block title %}Orders criadas{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-black mb-8">Orders criadas</h1>

<form id="filterForm" method="GET" class="mb-4 bg-gray-50 p-4 rounded shadow-sm border border-gray-200">
  
  <div class="flex flex-col md:flex-row gap-4 mb-4">
    <div class="flex-grow flex gap-2">
      <input type="text" name="q" value="{{ search_query }}" placeholder="Pesquisar Tracking, Plant, Courier..."
        class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring focus:ring-blue-300" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition font-semibold">
        Pesquisar
      </button>
    </div>
    
    {% if is_admin %}
      <a href="{% url 'orders' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition flex items-center justify-center font-semibold">
        Nova Order
      </a>
    {% endif %}
  </div>

  <div class="flex flex-wrap items-center gap-4 justify-between">
    <div class="flex gap-2">
      <input type="hidden" name="tipo" id="tipoInput" value="{{ filtro_tipo }}">
      
      <button type="button" id="btnImport" class="px-3 py-1 text-sm font-semibold rounded transition border">
        Filtrar Importação
      </button>
      <button type="button" id="btnExport" class="px-3 py-1 text-sm font-semibold rounded transition border">
        Filtrar Exportação
      </button>
      <button type="button" id="btnClear" class="px-3 py-1 text-sm font-semibold rounded bg-red-100 text-red-700 border-red-200 hover:bg-red-200 transition">
        Limpar Filtros
      </button>
    </div>

    <div class="flex items-center gap-2">
      <label for="limitSelect" class="text-sm font-semibold text-gray-700">Mostrar:</label>
      <select name="limit" id="limitSelect" onchange="this.form.submit()" class="border border-gray-300 rounded shadow-sm px-3 py-1 text-sm focus:ring-blue-300">
        <option value="15" {% if limite_escolhido == '15' %}selected{% endif %}>15 linhas</option>
        <option value="50" {% if limite_escolhido == '50' %}selected{% endif %}>50 linhas</option>
        <option value="100" {% if limite_escolhido == '100' %}selected{% endif %}>100 linhas</option>
        <option value="todos" {% if limite_escolhido == 'todos' %}selected{% endif %}>Todas as orders</option>
      </select>
    </div>
  </div>
</form>

  <!-- Tabela scrollável -->
  <p class="mb-2 text-sm text-gray-600">Clique em Shift + scroll do rato para dar Scroll horizontalmente</p>
  <div id="tableScroller" class="overflow-x-auto w-full max-w-7xl bg-white rounded-lg shadow-lg p-6">
    <table id="ordersTable" class="min-w-full table-auto text-xs md:text-sm text-left">
      <thead class="bg-blue-600 text-white uppercase font-semibold text-sm">
        <tr>
          <th class="px-4 py-3">Plant</th>
          <th class="px-4 py-3">Tracking</th>
          <th class="px-4 py-3">Courier</th>
          <th class="px-4 py-3">Shipping Date</th>
          <th class="px-4 py-3">Arriving Date</th>
          <th class="px-4 py-3 min-w-[260px]">Orders Coming</th>
          <th class="px-4 py-3">Tasks</th>
          <th class="px-4 py-3">Status</th>
          <th class="px-4 py-3">Comments</th>
          <th class="px-4 py-3">Ficheiros</th>
          {% if is_qOffice %}
          <th class="px-4 py-3">Exportado</th> 
          {% endif %}
          <th class="px-4 py-3 text-right">Ações</th>
        </tr>
      </thead>
      <tbody class="text-gray-800">
        {% for o in orders %}
          <tr class="border-b hover:bg-gray-100 transition-colors">
            <td class="px-4 py-2">{{ o.plant }}</td>
            <td class="px-4 py-2">{{ o.tracking_number }}</td>
            <td class="px-4 py-2">{{ o.courier }}</td>
            <td class="px-4 py-2">{{ o.shipping_date|default:"—" }}</td>
            <td class="px-4 py-2">{{ o.arriving_date|default:"—" }}</td>
            <td class="px-4 py-2">
              {% if o.orders_coming.all %}
                <ul class="list-disc list-inside space-y-1">
                  {% for oc in o.orders_coming.all %}
                    <li>
                      <a href="{% url 'editOrdersComing' oc.id %}" class="text-blue-600 hover:underline">
                        {{ oc.order|linebreaksbr|safe|cut:"<br />"|truncatechars:40 }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% if o.orders_coming.all %}
                <ul class="space-y-1">
                  {% for oc in o.orders_coming.all %}
                    <li>
                      {% if o.plant|lower != 'toma' %}
                        {% if oc.inspectionMetrology or oc.preshipment or oc.mark or oc.urgent %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-amber-100 text-amber-800 whitespace-nowrap">
                          Have Tasks
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700 whitespace-nowrap">
                          No Tasks
                        </span>
                        {% endif %}
                      {% else %}
                        
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="px-4 py-2">
              {% for oc in o.orders_coming.all %}
                {% if o.plant|lower != 'toma' %}
                  {% if oc in ordersComing %}
                    <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                      {% if oc.done == True %}Done{% else %}Pending{% endif %}
                    </span>
                  {% endif %}
                {%else%}

                {% endif %}
              {% empty %}
                <span class="text-gray-400">—</span>
              {% endfor %}
            </td>
            <td class="px-4 py-2">{{ o.comment|linebreaksbr|default:"—" }}</td>
            <td class="px-4 py-2">
              {% for f in o.files.all %}
                <div>
                  {% if f.restricted and not is_admin %}
                    <span class="text-gray-500 italic">Ficheiro restrito</span>
                  {% else %}
                    <a href="{{ f.file.url }}" class="text-blue-600 underline" target="_blank">
                      {{ f.file.name|cut:"order_files/"}}
                    </a>
                    {% if f.restricted %}
                      <span class="text-xs text-red-600 ml-1">(restrito)</span>
                    {% endif %}
                  {% endif %}
                </div>
              {% empty %}
                <span class="text-gray-500">—</span>
              {% endfor %}
            </td>
            {% if is_qOffice %}
            <td class="px-4 py-2">
              {% if o.exportado %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-green-100 text-green-800">
                  Exportado
                </span>
              {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-700">
                  Nunca
                </span>
              {% endif %}
            </td>
            {% endif %}
            <td class="px-4 py-2 text-right">
              <div class="flex flex-col gap-2 items-end">
                <a href="{% url 'editOrder' o.id %}"
                  class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition w-full text-center">
                  Editar
                </a>
                <form method="POST" action="{% url 'deleteOrder' o.id %}" class="w-full">
                  {% csrf_token %}
                  <button type="submit"
                          class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition w-full text-center"
                          onclick="return confirm('Deseja realmente eliminar esta order e os seus ficheiros?');">
                    Eliminar
                  </button>
                </form>
                <a href="{% url 'exportOrderExcel' o.id %}"
                  class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition w-full text-center export-btn">
                  {% if o.exportado %}Reexportar Excel{% else %}Exportar Excel{% endif %}
                </a>
              </div>
            </td>

          </tr>
        {% empty %}
          <tr>
            <td colspan="9" class="text-center text-gray-500 py-4">Sem orders ainda.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // =========================================================
  // 1. LÓGICA DE FILTROS E PESQUISA (Agora gerida pelo Django)
  // =========================================================
  const form = document.getElementById('filterForm');
  const tipoInput = document.getElementById('tipoInput');
  const btnImport = document.getElementById('btnImport');
  const btnExport = document.getElementById('btnExport');
  const btnClear = document.getElementById('btnClear');

  // Função para pintar os botões consoante o estado atual que veio do Django
  function pintarBotoes() {
      if (!tipoInput) return; // Segurança extra caso a página carregue diferente
      
      const tipoAtual = tipoInput.value;
      
      // Classes base (Botões a cinzento - Inativos)
      const baseClass = "px-3 py-1 text-sm font-semibold rounded transition border bg-gray-200 text-gray-800 hover:bg-gray-300";
      // Classes ativos (Botões a azul)
      const activeClass = "px-3 py-1 text-sm font-semibold rounded transition border bg-blue-600 text-white border-blue-700 hover:bg-blue-700";

      // Reset a todos para o estado base
      if(btnImport) btnImport.className = baseClass;
      if(btnExport) btnExport.className = baseClass;

      // Pinta de azul apenas o que estiver selecionado
      if (tipoAtual === 'import' && btnImport) {
          btnImport.className = activeClass;
      } else if (tipoAtual === 'export' && btnExport) {
          btnExport.className = activeClass;
      }
  }

  // Correr logo ao carregar a página para pintar os botões corretamente
  pintarBotoes();

  // Quando clica no botão Importação
  if (btnImport) {
      btnImport.addEventListener('click', function() {
          // Se já estava 'import', muda para 'todos', senão muda para 'import'
          tipoInput.value = (tipoInput.value === 'import') ? 'todos' : 'import';
          form.submit(); // Manda logo o formulário para o Django recarregar a página!
      });
  }

  // Quando clica no botão Exportação
  if (btnExport) {
      btnExport.addEventListener('click', function() {
          tipoInput.value = (tipoInput.value === 'export') ? 'todos' : 'export';
          form.submit();
      });
  }

  // Quando clica em Limpar
  if (btnClear) {
      btnClear.addEventListener('click', function() {
          tipoInput.value = 'todos'; // Reseta o tipo (Import/Export)
          
          // Limpa o texto da caixa de pesquisa
          const barraPesquisa = document.querySelector('input[name="q"]');
          if (barraPesquisa) barraPesquisa.value = ''; 
          
          form.submit(); // Recarrega a página limpa
      });
  }


  // =========================================================
  // 2. CÓDIGO EXISTENTE DE SCROLL E EXPORTAÇÃO (Intacto!)
  // =========================================================
  
  // Scroll superior sincronizado
  const tableScroller = document.getElementById('tableScroller');
  const topScroller = document.getElementById('topScroller');
  const topInner = document.getElementById('topScrollerInner');

  function syncWidths() {
    if(topInner && tableScroller) {
        topInner.style.width = tableScroller.scrollWidth + 'px';
    }
  }

  if (tableScroller && topScroller) {
      tableScroller.addEventListener('scroll', () => {
        topScroller.scrollLeft = tableScroller.scrollLeft;
      });
      topScroller.addEventListener('scroll', () => {
        tableScroller.scrollLeft = topScroller.scrollLeft;
      });
  }
  
  window.addEventListener('load', syncWidths);

  // Refresh suave após exportar
  document.querySelectorAll('.export-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const original = btn.textContent;
      btn.textContent = 'A gerar…';
      btn.classList.add('opacity-70','pointer-events-none');
      setTimeout(() => { window.location.reload(); }, 2500);
      setTimeout(() => {
        btn.textContent = original;
        btn.classList.remove('opacity-70','pointer-events-none');
      }, 8000);
    });
  });

</script>
{% endblock %}