{% extends 'theme/base.html' %}

{% block title %}Calendário de Entregas{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-white mb-6">Calendário de Entregas – {{ month_name }} {{ year }}</h1>

<div class="flex flex-col lg:flex-row gap-6">

  <!-- Calendário -->
  <div class="flex-1 bg-white rounded-lg shadow p-4">
    <!-- Navegação -->
    <div class="flex items-center justify-between mb-4">
      <a href="{% url 'deliveryCalendar' %}?year={{ prev_year }}&month={{ prev_month }}"
         class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200">&larr; Anterior</a>
      <div class="text-lg font-semibold">{{ month_name }} {{ year }}</div>
      <a href="{% url 'deliveryCalendar' %}?year={{ next_year }}&month={{ next_month }}"
         class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200">Seguinte &rarr;</a>
    </div>

    <!-- Cabeçalho dos dias -->
    <div class="grid grid-cols-7 text-xs md:text-sm font-semibold text-gray-600 border-b pb-2">
      <div class="text-center">Seg</div>
      <div class="text-center">Ter</div>
      <div class="text-center">Qua</div>
      <div class="text-center">Qui</div>
      <div class="text-center">Sex</div>
      <div class="text-center">Sáb</div>
      <div class="text-center">Dom</div>
    </div>

    <!-- Semanas -->
    <div class="grid grid-cols-7 gap-2 mt-2">
      {% for week in weeks %}
        {% for cell in week %}
          <div class="min-h-28 border rounded p-2 relative
                      {% if not cell.in_month %} bg-gray-50 text-gray-400 {% else %} bg-white {% endif %}
                      {% if cell.is_soon %} ring-2 ring-red-400 {% endif %}
                      {% if cell.is_today %} outline outline-2 outline-blue-400 {% endif %}">
            <!-- Número do dia -->
            <div class="text-xs md:text-sm font-semibold">
              {{ cell.date.day }}
            </div>

            <!-- Eventos -->
            <div class="mt-1 space-y-1">
              {% for ev in cell.events %}
                <a href="{% url 'deliveryIdentification' ev.identificator.toma_order_full %}"
                   class="block text-xs md:text-sm px-2 py-1 rounded
                          {% if cell.is_soon %} bg-red-100 text-red-800
                          {% else %} bg-blue-50 text-blue-800 {% endif %}
                          hover:bg-blue-100">
                    <!-- Mostra entidade ou cliente -->
                    {% if ev.deliveryEntity %}
                        {{ ev.deliveryEntity.name }}
                    {% else %}
                        N/A
                    {% endif %}
                </a>
              {% empty %}
                <!-- sem eventos para o dia -->
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>

    <!-- Legenda -->
    <div class="mt-4 text-sm text-gray-600 flex items-center gap-4">
      <span class="inline-flex items-center gap-2"><span class="w-3 h-3 inline-block bg-red-300 rounded"></span> Dentro de 7 dias</span>
      <span class="inline-flex items-center gap-2"><span class="w-3 h-3 inline-block bg-blue-200 rounded"></span> Evento normal</span>
      <span class="inline-flex items-center gap-2"><span class="w-3 h-3 inline-block outline outline-2 outline-blue-400 rounded"></span> Hoje</span>
    </div>
  </div>

  <!-- Avisos (próximos 7 dias) -->
  <aside class="w-full lg:w-80 bg-white rounded-lg shadow p-4 h-fit">
    <h2 class="text-lg font-semibold mb-3">Avisos (7 dias)</h2>
    <ul class="space-y-2">
      {% for ev in soon_events %}
        <li class="border rounded p-2 flex flex-col">
          <div class="text-sm text-gray-600">{{ ev.deliveryDate|date:"d/m/Y" }}</div>
          <div class="font-medium">
            <a href="{% url 'deliveryIdentification' ev.identificator.toma_order_full %}" class="text-blue-700 hover:underline">
              TOMA {{ ev.identificator.toma_order_full }}
            </a>
          </div>
          <div class="text-sm text-gray-700">
            {% if ev.deliveryType and ev.deliveryType.name == 'Customer' %}
              Cliente: {{ ev.identificator.customer }}
            {% else %}
              {% if ev.deliveryEntity %}
                Entidade: {{ ev.deliveryEntity.name }}
              {% else %}
                Entidade: N/A
              {% endif %}
            {% endif %}
          </div>
        </li>
      {% empty %}
        <li class="text-gray-500 text-sm">Sem entregas nos próximos 7 dias.</li>
      {% endfor %}
    </ul>
  </aside>

</div>
{% endblock %}
