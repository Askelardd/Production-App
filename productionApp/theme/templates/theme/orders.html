{% extends 'theme/base.html' %}
{% block title %}Orders{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-black mb-8">Orders</h1>

<form method="POST" action="{% url 'orders' %}" enctype="multipart/form-data"
      class="bg-white p-6 rounded-lg shadow-md">
  {% csrf_token %}

  <div class="mb-4">
    <label for="plant" class="block text-gray-700">Plant</label>
    <select id="plant" name="plant" class="border border-gray-300 rounded-lg p-2 w-full">
      <option value="">Select Plant</option>
      {% for plant in plant_choices %}
        <option value="{{ plant }}">{{ plant }}</option>
      {% endfor %}
    </select>

  <div class="mb-4">
    <label for="tracking_number" class="block text-gray-700">Tracking Number</label>
    <input type="text" id="tracking_number" name="tracking_number"
           class="border border-gray-300 rounded-lg p-2 w-full" required>
  </div>

  <div class="mb-4">
    <label class="block text-gray-700">Orders Coming</label>
    <div id="created-orders-list" class="space-y-1 mb-2"></div>

    <!-- hidden inputs onde os IDs dos novos OrdersComing vão ser colocados -->
    <div id="orders-coming-hidden-container"></div>

    <button type="button" onclick="openOrdersComingModal()"
            class="bg-green-500 text-white px-3 py-1 rounded">
      + Novo
    </button>
  </div>


  <div class="mb-4">
    <label for="courier" class="block text-gray-700">Courier</label>
    <select id="courier" name="courier" class="border border-gray-300 rounded-lg p-2 w-full">
      <option value="">Select Courier</option>
      {% for courier in courier_choices %}
        <option value="{{ courier }}">{{ courier }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-4">
    <label for="shipping_date" class="block text-gray-700">Shipping Date</label>
    <input type="date" id="shipping_date" name="shipping_date"
           class="border border-gray-300 rounded-lg p-2 w-full">
  </div>

  <div class="mb-4">
    <label for="comment" class="block text-gray-700">Comment</label>
    <textarea id="comment" name="comment"
              class="border border-gray-300 rounded-lg p-2 w-full"></textarea>
  </div>

<div class="mb-4">
    <label for="files" class="block text-gray-700">Upload Files</label>
    <div 
        id="file-drop-area"
        class="flex items-center justify-center border-2 border-dashed border-gray-400 rounded-lg p-8 bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer"
        onclick="document.getElementById('files').click();"
        ondragover="event.preventDefault(); this.classList.add('bg-blue-50', 'border-blue-400');"
        ondragleave="this.classList.remove('bg-blue-50', 'border-blue-400');"
        ondrop="event.preventDefault(); handleFiles(event.dataTransfer.files); this.classList.remove('bg-blue-50', 'border-blue-400');"
        style="min-height: 120px;"
    >
        <span id="file-drop-text" class="text-gray-500">Arraste e solte os ficheiros aqui ou clique para selecionar</span>
        <input type="file" id="files" name="files" multiple class="hidden">
    </div>

    <!-- Aqui vão aparecer os nomes dos ficheiros -->
    <div id="file-list" class="mt-3 space-y-2"></div>
</div>

  <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
    Submit Order
  </button>
  <a href="{% url 'listarOrders' %}">
    <button type="button" class="ml-3 bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors">
      Voltar
    </button>
  </a>
</form>


<!-- Modal -->
<div id="ordersComingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Adicionar Orders Coming</h2>
    <form id="ordersComingForm">
      {% csrf_token %}
      <label class="block mb-2 text-sm text-gray-700">Nome da Ordem</label>
      <input type="text" id="oc_order" name="order" required class="w-full p-2 border rounded mb-4">

      <label class="flex items-center space-x-2 mb-2">
        <input type="checkbox" name="urgent" id="oc_urgent">
        <span>Urgente</span>
      </label>

      <label class="flex items-center space-x-2 mb-2">
        <input type="checkbox" name="inspectionMetrology" id="oc_inspectionMetrology">
        <span>Inspection Metrology</span>
      </label>

      <label class="flex items-center space-x-2 mb-2">
        <input type="checkbox" name="preshipment" id="oc_preshipment">
        <span>Pre-Shipment</span>
      </label>

      <label class="flex items-center space-x-2 mb-2">
        <input type="checkbox" name="mark" id="oc_mark">
        <span>Mark</span>
      </label>

      <label class="flex items-center space-x-2 mb-2">
        <input type="checkbox" name="done" id="oc_done">
        <span>Done</span>
      </label>

      <label class="block text-sm text-gray-700 mb-1">Comentário</label>
      <textarea id="oc_comment" name="comment" class="w-full p-2 border rounded mb-4"></textarea>

      <div class="flex justify-end space-x-2">
        <button type="button" onclick="closeOrdersComingModal()" class="text-gray-600">Cancelar</button>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Salvar</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
  function openOrdersComingModal() {
    document.getElementById('ordersComingModal').classList.remove('hidden');
  }

  function closeOrdersComingModal() {
    document.getElementById('ordersComingModal').classList.add('hidden');
  }

  function handleFiles(files) {
    const fileInput = document.getElementById('files');
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';

    Array.from(files).forEach((file, index) => {
      const row = document.createElement('div');
      row.className = "flex items-center gap-3";

      row.innerHTML = `
        <span class="text-gray-700">${file.name}</span>
        <input type="checkbox" name="restricted_${index}" value="1"
               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
        <label class="text-sm text-gray-600">Restrito</label>
      `;

      fileList.appendChild(row);
    });

    // Reatribui os ficheiros ao input oculto (drag & drop)
    if (fileInput) {
      const dataTransfer = new DataTransfer();
      Array.from(files).forEach(file => dataTransfer.items.add(file));
      fileInput.files = dataTransfer.files;
    }
  }

  document.getElementById('files').addEventListener('change', function(e) {
    handleFiles(e.target.files);
  });

  // Submit do modal de OrdersComing via AJAX
  document.getElementById('ordersComingForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const data = {
      order: document.getElementById('oc_order').value,
      urgent: document.getElementById('oc_urgent').checked,
      comment: document.getElementById('oc_comment').value
    };

    fetch("{% url 'create_orders_coming_ajax' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(json => {
      if (json.success) {
        // adicionar visualmente na interface
        const list = document.getElementById('created-orders-list');
        const item = document.createElement('div');
        item.className = "text-sm text-blue-800";
        item.innerHTML = `<a href="/orders/coming/${json.data.id}/edit/" target="_blank" class="underline">${json.data.order}</a>`;
        list.appendChild(item);

        // adicionar hidden input com ID
        const hiddenContainer = document.getElementById('orders-coming-hidden-container');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'orders_coming';  // Django espera name igual no getlist
        input.value = json.data.id;
        hiddenContainer.appendChild(input);

        closeOrdersComingModal();
        document.getElementById('ordersComingForm').reset();
      } else {
        alert("Erro ao criar: " + json.message);
      }
    });
  });
</script>

{% endblock %}

