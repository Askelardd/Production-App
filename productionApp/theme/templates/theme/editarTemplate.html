{% extends 'theme/base.html' %}
{% load static %} 

{% block title %}Editar Template{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-4">
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="bg-gray-800 px-6 py-4">
            <h2 class="text-xl font-semibold text-white">Edit Template: {{ template.name }}</h2>
        </div>

        <form method="POST" enctype="multipart/form-data" class="p-6 space-y-6">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div>
                    <label for="name" class="block text-sm font-semibold text-gray-700">Name</label>
                    <input type="text" id="name" name="name" required value="{{ template.name }}"
                        class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                </div>
                <div>
                    <label for="department" class="block text-sm font-semibold text-gray-700">Department</label>
                    <input type="text" id="department" name="department" required value="{{ template.department }}"
                        class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                </div>
            </div>

            <div>
                <label for="description" class="block text-sm font-semibold text-gray-700">Description</label>
                <textarea id="description" name="description" rows="3" 
                    class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">{{ template.description }}</textarea>
            </div>

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div>
                    <label for="approved" class="block text-sm font-semibold text-gray-700">Approved Status</label>
                    <select id="approved" name="approved" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                        <option value="True" {% if template.approved %}selected{% endif %}>Yes</option>
                        <option value="False" {% if not template.approved %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div>
                    <label for="approved_by" class="block text-sm font-semibold text-gray-700">Approved By</label>
                    <input type="text" id="approved_by" name="approved_by" value="{{ template.approved_by }}"
                        class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                </div>
            </div>
            
            <hr class="border-gray-200 my-4">

            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div>
                    <label for="created_at" class="block text-sm font-semibold text-gray-700">Created At</label>
                    <input type="date" id="created_at" name="created_at" value="{{ template.created_at|date:'Y-m-d' }}"
                        class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                </div>

                <div>
                    <label for="last_updated" class="block text-sm font-semibold text-gray-700">Last Updated</label>
                    <input type="date" id="last_updated" name="last_updated" value="{{ template.last_updated|date:'Y-m-d' }}"
                        class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2.5">
                </div>
            </div>

            <hr class="border-gray-200 my-4">


            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Template Files (PDF, DOC, DOCX)</label>
                {% if template.files.all %}
                <div class="mb-4">
                    <p class="text-xs text-gray-500 uppercase tracking-wide mb-2">Ficheiros Atuais:</p>
                    <ul class="space-y-2">
                        {% for t_file in template.files.all %}
                        <li id="file-row-{{ t_file.id }}" class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200 transition-all duration-300">
                            <div class="flex items-center truncate">
                                <i class="fa-solid fa-file text-indigo-500 mr-2"></i>
                                <a href="{{ t_file.file.url }}" target="_blank" class="text-sm text-blue-600 hover:underline truncate">
                                    {{ t_file.file.name|cut:'templates_files/' }}
                                </a>
                            </div>
                            
                            <button type="button" 
                                    onclick="deleteExistingFile({{ t_file.id }})"
                                    class="text-red-400 hover:text-red-600 text-xs p-1 hover:bg-red-50 rounded transition"
                                    title="Apagar ficheiro">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div id="drop-zone-multi" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:bg-gray-50 transition bg-white">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                        <div class="flex text-sm text-gray-600 justify-center">
                            <span class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                <span>Add new files</span>
                            </span>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">Adicionar novos (mantém os antigos)</p>
                    </div>
                </div>
                
                <input type="file" id="fileInputMulti" name="file" multiple accept=".pdf,.doc,.docx" class="hidden">
                <ul id="fileListMulti" class="mt-4 space-y-2"></ul>
                <p id="errorMulti" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>

            <div class="mt-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Approved File (Substituir)</label>
                
                {% if template.approved_file %}
                <div class="mb-4 bg-green-50 border border-green-200 p-3 rounded flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-xs font-bold text-green-700 mr-2 uppercase">Atual:</span>
                        <a href="{{ template.approved_file.url }}" target="_blank" class="text-sm text-blue-600 hover:underline">
                            {{ template.approved_file.name|cut:'approved_templates_files/' }}
                        </a>
                    </div>
                </div>
                {% endif %}

                <div id="drop-zone-approved" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:bg-gray-50 transition bg-white">
                    <div class="space-y-1 text-center">
                        <i class="fa-solid fa-certificate text-4xl text-gray-400"></i>
                        <div class="flex text-sm text-gray-600 justify-center mt-2">
                            <span class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500">
                                <span>Upload approved file</span>
                            </span>
                        </div>
                        <p class="text-xs text-gray-500">Drag to replace current file</p>
                    </div>
                </div>

                <input type="file" id="fileInputApproved" name="approved_file" accept=".pdf,.doc,.docx" class="hidden">
                <ul id="fileListApproved" class="mt-4 space-y-2"></ul>
                <p id="errorApproved" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>

            <div class="flex justify-end pt-4">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                    Save Changes
                </button>
                <a href="{% url 'templateFiles' %}" class="ml-3 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    // Função Configuradora que serve para qualquer Dropzone
    function setupDropZone(config) {
        const dropZone = document.getElementById(config.zoneId);
        const fileInput = document.getElementById(config.inputId);
        const fileList = document.getElementById(config.listId);
        const errorMessage = document.getElementById(config.errorId);
        const allowedExtensions = ['pdf', 'doc', 'docx'];
        
        let dataTransfer = new DataTransfer();

        // 1. Click
        dropZone.addEventListener('click', () => fileInput.click());

        // 2. Drag Effects
        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
            });
        });

        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
        });

        // 3. Drop & Change
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            errorMessage.classList.add('hidden');
            let hasInvalid = false;

            // Se não for múltiplo, limpa os anteriores
            if (!config.isMultiple) {
                dataTransfer = new DataTransfer(); 
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (allowedExtensions.includes(ext)) {
                    dataTransfer.items.add(file);
                } else {
                    hasInvalid = true;
                }
            }

            if (hasInvalid) {
                errorMessage.textContent = "Apenas PDF, DOC e DOCX são permitidos.";
                errorMessage.classList.remove('hidden');
            }

            fileInput.files = dataTransfer.files;
            renderList();
        }

        function renderList() {
            fileList.innerHTML = '';
            for (let i = 0; i < dataTransfer.files.length; i++) {
                const file = dataTransfer.files[i];
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded border text-sm text-gray-700";
                li.innerHTML = `
                    <span class="truncate">${file.name}</span>
                    <button type="button" class="text-red-500 ml-2" data-index="${i}">&times;</button>
                `;
                // Botão remover da lista de upload
                li.querySelector('button').onclick = function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    const newDataTransfer = new DataTransfer();
                    for (let j = 0; j < dataTransfer.files.length; j++) {
                        if (j !== idx) newDataTransfer.items.add(dataTransfer.files[j]);
                    }
                    dataTransfer = newDataTransfer;
                    fileInput.files = dataTransfer.files;
                    renderList();
                };
                fileList.appendChild(li);
            }
        }
    }
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Função para apagar o ficheiro
        function deleteExistingFile(fileId) {
            // 1. Pergunta de confirmação (Opcional, mas recomendado)
            if (!confirm("Tem a certeza que deseja apagar este ficheiro permanentemente?")) {
                return;
            }

            const url = `/delete-file/${fileId}/`; // Tem de bater certo com o urls.py
            const row = document.getElementById(`file-row-${fileId}`);

            // 2. Efeito visual de "A apagar..."
            row.style.opacity = '0.5';

            // 3. Pedido ao Servidor
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 4. Sucesso: Remove a linha do HTML suavemente
                    row.remove();
                } else {
                    alert("Erro ao apagar: " + data.message);
                    row.style.opacity = '1'; // Restaura se der erro
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Erro de conexão.");
                row.style.opacity = '1';
            });
        }
    // INICIALIZAR AS DUAS ZONAS
    document.addEventListener('DOMContentLoaded', () => {
        // Zona 1: Múltiplos Ficheiros
        setupDropZone({
            zoneId: 'drop-zone-multi',
            inputId: 'fileInputMulti',
            listId: 'fileListMulti',
            errorId: 'errorMulti',
            isMultiple: true
        });

        // Zona 2: Ficheiro Aprovado (Único)
        setupDropZone({
            zoneId: 'drop-zone-approved',
            inputId: 'fileInputApproved',
            listId: 'fileListApproved',
            errorId: 'errorApproved',
            isMultiple: false
        });
    });
</script>
{% endblock %}