{% extends 'theme/base.html' %}
{% block title %}Caminhos das Fieiras{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6">Histórico de Caminhos das Fieiras</h2>

<!-- Barra de Pesquisa -->
<div class="mb-4">
    <input type="text" id="searchInput" placeholder="Pesquisar em todos os campos..."
        class="w-full md:w-1/2 px-4 py-2 border rounded shadow focus:outline-none focus:ring focus:ring-blue-300" />
</div>

<table id="fieirasTable" class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Número de Encomenda</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Número de Série</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cone</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Caminho / Histórico</th>
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
        {% for path in paths %}
            {% if path.locations %}
                <tr>
                    <td class="px-4 py-2">{{ path.customer.customer|default:"-" }}</td>
                    <td class="px-4 py-2 text-gray-600">
                        {{ path.customer.customer_order_nr|default:"-" }}
                    </td>
                    <td class="px-4 py-2 font-semibold text-gray-800">{{ path.serial_number }}</td>
                    <td class="px-4 py-2">{{ path.cone }}</td>
                    <td class="px-4 py-2">
                        <ul class="list-disc ml-4 text-sm text-gray-700">
                            {% for loc in path.locations %}
                                <li>{{ loc.get_where_display }} — {{ loc.updated_at|date:"Y-m-d H:i" }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                </tr>
            {% endif %}
        {% empty %}
        <tr>
            <td colspan="5" class="text-center text-gray-500 py-4">Nenhuma fieira encontrada.</td>
        </tr>
        {% endfor %}
    </tbody>
{% endblock %}
{% block extra_js %}
<script>
        document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('fieirasTable').getElementsByTagName('tbody')[0];

        searchInput.addEventListener('keyup', function () {
            const filter = searchInput.value.toLowerCase();
            const rows = table.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < cells.length - 1; j++) { // Ignora última coluna (Ações)
                    if (cells[j].textContent.toLowerCase().includes(filter)) {
                        found = true;
                        break;
                    }
                }
                rows[i].style.display = found ? '' : 'none';
            }
        });
    });
</script>
{% endblock %}
