{% extends 'theme/base.html' %}

{% block title %}Invoices{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold text-black mb-8">Invoices</h1>


<div class="mb-4 flex justify-between items-center">
  <input type="text" id="searchInput" placeholder="Search all fields..."
    class="w-full md:w-1/2 px-4 py-2 border rounded shadow focus:outline-none focus:ring focus:ring-blue-300" />

    <div class="flex space-x-2">
    <a class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-900 transition text-sm" id="addFornecedorButton">
        Criar Fornecedor
    </a>
  </div>
</div>

<div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50" id="insertFornecedorForm">
    <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto relative">
        
        <h2 class="text-xl font-bold mb-6 text-gray-800">Novo Fornecedor</h2>
        
        <form id="fornecedorForm" action="{% url 'listarFornecedores' %}" method="post" class="flex flex-col space-y-6">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" name="nome" placeholder="Name" required
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />
                
                <input type="text" name="vat" placeholder="VAT" required
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />

                <input type="email" name="email" placeholder="Email" required
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />

                <input type="text" name="telefone" placeholder="Telefone"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />

                <input type="text" name="dados_bancarios" placeholder="Dados Bancarios"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />

                <input type="text" name="morada" placeholder="Morada"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring focus:ring-blue-300 text-gray-800" />

                <input type="checkbox" name="debito_direto" id="debito_direto" class="hidden" />

                <label class="flex items-center cursor-pointer">
                    <span class="mr-2 text-gray-800">Débito Direto</span>
                    
                    <input type="checkbox" name="debito_direto" class="peer sr-only" {% if fornecedor.debito_direto %}checked{% endif %} />
                    
                    <div class="w-10 h-5 bg-gray-300 rounded-full relative transition-colors duration-200 peer-checked:bg-green-500 peer-checked:[&>div]:translate-x-5">
                        
                        <div class="w-4 h-4 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform duration-200"></div>
                    </div>
                </label>

                <div class="mt-4"> 
                    <label class="flex items-center cursor-pointer">
                        <span class="mr-2 text-gray-800">Estrangeiro</span>
                        
                        <input type="checkbox" name="estrangeiro" class="peer sr-only" {% if fornecedor.estrangeiro %}checked{% endif %} />
                        
                        <div class="w-10 h-5 bg-gray-300 rounded-full relative transition-colors duration-200 peer-checked:bg-green-500 peer-checked:[&>div]:translate-x-5">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform duration-200"></div>
                        </div>
                    </label>
                </div>
                
            </div>
            <div class="flex items-center space-x-4">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-900 transition">
                    Save
                </button>
                <a href="{% url 'listarFornecedores' %}" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-900 transition cursor-pointer text-center">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<div class="overflow-x-auto w-full max-w-7xl bg-white rounded-lg shadow-lg p-6">
    <table id="fornecedorTable" class="min-w-full table-auto text-xs md:text-sm text-left">
        <thead class="bg-custom-blue text-black">
            <tr>
                <th class="px-4 py-3">Name</th>
                <th class="px-4 py-3">VAT</th>
                <th class="px-4 py-3">Email</th>
                <th class="px-4 py-3">Telefone</th>
                <th class="px-4 py-3">Dados Bancarios</th>
                <th class="px-4 py-3">Morada</th>
                <th class="px-4 py-3">Debito Direto</th>
                <th class="px-4 py-3">Estrangeiro</th>
                <th class="px-4 py-3 text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for fornecedor in fornecedores %}
            <tr class="border-b hover:bg-gray-50 transition">
                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="name">{{ fornecedor.name }}</td>

                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="vat">{{ fornecedor.vat }}</td>

                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="email">{{ fornecedor.email }}</td>
                    
                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="telefone">{{ fornecedor.telefone }}</td>

                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="dados_bancarios">{{ fornecedor.dados_bancarios }}</td>

                <td class="editable px-4 py-3 cursor-pointer hover:bg-gray-100" 
                    data-id="{{ fornecedor.id }}" 
                    data-field="morada">{{ fornecedor.morada }}</td>

                <td class="px-4 py-3 text-center">
                    <span 
                        class="toggle-bool cursor-pointer px-2 py-1 rounded-full text-xs font-semibold
                        {% if fornecedor.debito_direto %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
                        data-id="{{ fornecedor.id }}" 
                        data-field="debito_direto" 
                        data-value="{{ fornecedor.debito_direto|yesno:'true,false' }}">
                        
                        {% if fornecedor.debito_direto %}Sim{% else %}Não{% endif %}
                    </span>
                </td>

                <td class="px-4 py-3 text-center">
                    <span 
                        class="toggle-bool cursor-pointer px-2 py-1 rounded-full text-xs font-semibold
                        {% if fornecedor.estrangeiro %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
                        data-id="{{ fornecedor.id }}" 
                        data-field="estrangeiro" 
                        data-value="{{ fornecedor.estrangeiro|yesno:'true,false' }}">

                        {% if fornecedor.estrangeiro %}Sim{% else %}Não{% endif %}
                    </span>
                </td>
                
                <td class="px-4 py-3 text-center">
                    <form method="POST" action="{% url 'deletar_fornecedor' fornecedor.id %}" style="display:inline;">                        {% csrf_token %}
                        {% if request.user.groups.all.0.name in "Administracao" %}
                        <button type="submit" class="text-red-600 hover:underline text-sm px-2"
                                onclick="return confirm('Are you sure you want to delete this record?')">
                            Delete
                        </button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block extra_js %}
<script>

    document.getElementById('addFornecedorButton').addEventListener('click', function() {
        document.getElementById('insertFornecedorForm').classList.remove('hidden');
    });

    document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#fornecedorTable tbody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let match = false;
            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(searchTerm)) {
                    match = true;
                }
            });
            row.style.display = match ? '' : 'none';
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const editableCells = document.querySelectorAll('.editable');
        const toggleButtons = document.querySelectorAll('.toggle-bool');

        toggleButtons.forEach(btn => {
            btn.addEventListener('click', async function() {
                const id = this.dataset.id;
                const field = this.dataset.field;
                // Vê se o valor atual é string "true" e inverte
                const currentValue = this.dataset.value === 'true'; 
                const newValue = !currentValue;

                try {
                    // Efeito visual (opacidade) enquanto carrega
                    this.style.opacity = '0.5';

                    const response = await fetch(`/atualizar-fornecedor/${id}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            field: field,
                            value: newValue
                        })
                    });

                    if (response.ok) {
                        // Atualiza os dados no HTML
                        this.dataset.value = newValue; 
                        this.textContent = newValue ? 'Sim' : 'Não';

                        // Troca as cores (Verde <-> Vermelho)
                        if (newValue) {
                            this.classList.remove('bg-red-100', 'text-red-800');
                            this.classList.add('bg-green-100', 'text-green-800');
                        } else {
                            this.classList.remove('bg-green-100', 'text-green-800');
                            this.classList.add('bg-red-100', 'text-red-800');
                        }
                    } else {
                        alert('Erro ao atualizar!');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro de conexão.');
                } finally {
                    this.style.opacity = '1';
                }
            });
        });
        // -----------------------------------------------------

        // Lógica do Duplo Clique (Texto)
        editableCells.forEach(cell => {
            cell.addEventListener('dblclick', function() {
                if (this.querySelector('input')) return;

                const currentText = this.innerText;
                const field = this.dataset.field;
                const id = this.dataset.id;

                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.className = 'w-full px-2 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-black';
                
                this.innerHTML = '';
                this.appendChild(input);
                input.focus();

                const save = async () => {
                    const newValue = input.value;
                    
                    if (newValue === currentText) {
                        this.innerHTML = currentText;
                        return;
                    }

                    try {
                        const response = await fetch(`/atualizar-fornecedor/${id}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                field: field,
                                value: newValue
                            })
                        });

                        if (response.ok) {
                            this.innerHTML = newValue;
                        } else {
                            alert('Erro ao guardar!');
                            this.innerHTML = currentText;
                        }
                    } catch (error) {
                        console.error('Erro:', error);
                        this.innerHTML = currentText;
                    }
                };

                input.addEventListener('blur', save);
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
            });
        });
    });
</script>
{% endblock %}